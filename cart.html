<script type="module">
    // 1. Firebase Imports (Zaroori hain)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCYzkMGDwWZGx_PlrNfjloYZ6PVQRne9wg",
        authDomain: "web-app-4f3a1.firebaseapp.com",
        projectId: "web-app-4f3a1",
        databaseURL: "https://web-app-4f3a1-default-rtdb.firebaseio.com",
        storageBucket: "web-app-4f3a1.firebasestorage.app",
        messagingSenderId: "222099203820",
        appId: "1:222099203820:web:778e204d2960181dfba7c9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Global variable user ke liye
    let currentUser = null;
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
    });

    // 2. Load Cart Logic
    function loadCart() {
        const cart = JSON.parse(localStorage.getItem('haider_cart')) || [];
        const cartList = document.getElementById('cartList');
        const summaryBox = document.getElementById('summaryBox');
        const emptyCart = document.getElementById('emptyCart');
        const totalDisplay = document.getElementById('totalPrice');

        if (cart.length === 0) {
            cartList.innerHTML = "";
            summaryBox.style.display = "none";
            emptyCart.style.display = "block";
            return;
        }

        emptyCart.style.display = "none";
        summaryBox.style.display = "block";
        cartList.innerHTML = "";
        
        let total = 0;
        cart.forEach((item, index) => {
            const cleanPrice = item.price.toString().replace(/[^\d]/g, "");
            total += parseInt(cleanPrice) || 0;
            cartList.innerHTML += `
                <div class="cart-item">
                    <img src="${item.img}" onerror="this.src='https://via.placeholder.com/80?text=Mobile'">
                    <div class="item-info">
                        <h3>${item.name}</h3>
                        <p>${item.price}</p>
                    </div>
                    <div class="remove-btn" onclick="window.removeItem(${index})">
                        <i class="fa fa-trash-can"></i>
                    </div>
                </div>`;
        });
        totalDisplay.innerText = "Rs " + total.toLocaleString();
    }

    // Functions ko window object se attach karna taake HTML button unhe dekh sake
    window.removeItem = (index) => {
        let cart = JSON.parse(localStorage.getItem('haider_cart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('haider_cart', JSON.stringify(cart));
        loadCart();
    };

    window.sendWhatsApp = async () => {
        const cart = JSON.parse(localStorage.getItem('haider_cart')) || [];
        if (cart.length === 0) return;

        const totalAmount = document.getElementById('totalPrice').innerText;
        const itemsNames = cart.map(i => i.name).join(", ");

        // --- YAHA ORDER SAVE HO RAHA HAI ---
        if (currentUser) {
            try {
                const ordersRef = ref(db, 'users/' + currentUser.uid + '/orders');
                await push(ordersRef, {
                    date: new Date().toLocaleDateString(),
                    items: itemsNames,
                    total: totalAmount,
                    status: "Processing"
                });
                console.log("Order saved to database!");
            } catch (e) {
                console.error("Database error:", e);
            }
        } else {
            alert("Please login so we can save your order history!");
        }

        // WhatsApp Message logic
        let message = "ðŸ“¦ *NEW ORDER - HAIDER MOBILES*%0A--------------------------%0A";
        cart.forEach((item, i) => {
            message += `*${i+1}.* ${item.name} - ${item.price}%0A`;
        });
        message += "--------------------------%0A";
        message += `ðŸ’° *TOTAL: ${totalAmount}*%0A%0A`;
        message += "Please confirm my order!";
        
        const phone = "923279518790";
        window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
    };

    // Start
    loadCart();
</script>
