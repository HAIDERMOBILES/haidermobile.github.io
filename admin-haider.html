<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Haider Mobiles</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --gold: #d4af37; --bg: #0b0b0b; --card: #161616; }
        body { background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; }
        .admin-container { max-width: 1000px; margin: 0 auto; }
        h2 { color: var(--gold); text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #333; }
        .stat-card h4 { margin: 0; color: #888; font-size: 14px; }
        .stat-card p { font-size: 24px; font-weight: 800; color: var(--gold); margin: 10px 0 0; }

        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 15px; overflow: hidden; }
        th { background: #222; color: var(--gold); padding: 15px; text-align: left; font-size: 14px; }
        td { padding: 15px; border-bottom: 1px solid #222; font-size: 13px; }
        tr:hover { background: #1c1c1c; }

        .status-select { background: #000; color: var(--gold); border: 1px solid var(--gold); border-radius: 5px; padding: 5px; cursor: pointer; }
        .btn-view { background: var(--gold); color: #000; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="admin-container">
    <h2><i class="fa fa-user-tie"></i> HAIDER MOBILES ADMIN</h2>

    <div class="stats-grid">
        <div class="stat-card"><h4>Total Users</h4><p id="totalUsers">0</p></div>
        <div class="stat-card"><h4>Active Orders</h4><p id="totalOrders">0</p></div>
    </div>

    <h3>Customer Management</h3>
    <table>
        <thead>
            <tr>
                <th>Customer Name</th>
                <th>Phone & CNIC</th>
                <th>Recent Orders</th>
                <th>Update Status</th>
            </tr>
        </thead>
        <tbody id="adminTable">
            </tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCYzkMGDwWZGx_PlrNfjloYZ6PVQRne9wg",
        authDomain: "web-app-4f3a1.firebaseapp.com",
        projectId: "web-app-4f3a1",
        databaseURL: "https://web-app-4f3a1-default-rtdb.firebaseio.com",
        storageBucket: "web-app-4f3a1.firebasestorage.app",
        messagingSenderId: "222099203820",
        appId: "1:222099203820:web:778e204d2960181dfba7c9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Load All Data
    onValue(ref(db, 'users'), (snapshot) => {
        const adminTable = document.getElementById('adminTable');
        adminTable.innerHTML = "";
        let userCount = 0;
        let orderCount = 0;

        snapshot.forEach((childSnapshot) => {
            userCount++;
            const userId = childSnapshot.key;
            const userData = childSnapshot.val();
            const orders = userData.orders || {};

            let orderHtml = "";
            Object.keys(orders).forEach(orderId => {
                orderCount++;
                const order = orders[orderId];
                orderHtml += `
                    <div style="border-bottom: 1px solid #333; padding: 5px 0;">
                        ${order.items} <br>
                        <select class="status-select" onchange="window.updateOrderStatus('${userId}', '${orderId}', this.value)">
                            <option value="Pending" ${order.status==='Pending'?'selected':''}>Pending</option>
                            <option value="Shipped" ${order.status==='Shipped'?'selected':''}>Shipped</option>
                            <option value="Delivered" ${order.status==='Delivered'?'selected':''}>Delivered</option>
                        </select>
                    </div>`;
            });

            adminTable.innerHTML += `
                <tr>
                    <td><strong>${userData.name || 'N/A'}</strong><br><small>${userData.email}</small></td>
                    <td>${userData.phone || 'N/A'}<br><small>${userData.cnic || ''}</small></td>
                    <td>${orderHtml || '<span style="color:#444">No Orders</span>'}</td>
                    <td><button class="btn-view" onclick="alert('Address: ${userData.address}')">View Address</button></td>
                </tr>`;
        });

        document.getElementById('totalUsers').innerText = userCount;
        document.getElementById('totalOrders').innerText = orderCount;
    });

    // Function to update status in Database
    window.updateOrderStatus = (uid, oid, newStatus) => {
        const orderRef = ref(db, `users/${uid}/orders/${oid}`);
        update(orderRef, { status: newStatus })
        .then(() => alert("Status Updated to " + newStatus))
        .catch(err => alert("Error: " + err.message));
    };
</script>
</body>
</html>
